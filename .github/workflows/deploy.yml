name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Verify SSH key format
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" | head -n 2
          echo "----"
          echo "${{ secrets.EC2_SSH_KEY }}" | tail -n 2

      - name: Create SSH key file
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY_B64 }}" | base64 -d > ~/.ssh/ec2.pem
          chmod 600 ~/.ssh/ec2.pem

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key_path: ~/.ssh/ec2.pem
          port: 22
          debug: true
          script_stop: true
          script: |
            # Navigate to project directory or clone if doesn't exist
            if [ ! -d "HookHub" ]; then
              echo "Cloning repository for the first time..."
              git clone https://github.com/${{ github.repository }}.git
              cd HookHub
            else
              echo "Repository exists, pulling latest changes..."
              cd HookHub
              git fetch origin
              git reset --hard origin/main
              git pull origin main
            fi
            
            # Create .env file if it doesn't exist
            if [ ! -f .env ]; then
              echo "Creating .env file..."
              cp .env.example .env
              echo "‚ö†Ô∏è  Please update .env file with production values!"
            fi
            
            # Stop existing containers
            echo "Stopping existing containers..."
            docker-compose down
            
            # Remove old images to free space (optional)
            docker image prune -f
            
            # Build and start services
            echo "Building and starting services..."
            docker-compose up -d --build
            
            # Wait for services to be ready
            echo "Waiting for services to start..."
            sleep 15
            
            # Check deployment status
            echo "Checking deployment status..."
            docker-compose ps
            
            # Check application health
            echo "Checking application health..."
            sleep 10
            curl -f http://localhost:8080/actuator/health || echo "‚ö†Ô∏è  Health check failed"
            
            # Show recent logs
            echo "Recent application logs:"
            docker-compose logs --tail=50 hookhub-app
            
            echo "‚úÖ Deployment completed!"

      - name: Deployment Status
        if: success()
        run: echo "üöÄ Deployment to EC2 successful!"

      - name: Deployment Failed
        if: failure()
        run: echo "‚ùå Deployment to EC2 failed. Check the logs above."

